{% extends "base.html" %}

{% block title %} Submit Query {% endblock %}

{% block body %}

<center>
  
  <h3> Submit your protein sequence to search for potential protein binders.</h3>

  <br>
  Good day!
  <br><br>


  <br><br>
  <form method="POST">

     <p>Drop your sequence here:<br> <input type="text" name="sequence" value="{{ sequence }}"></p>
     <p>Tag your job for identification:<br> <input type="text" name="tag" value="{{ tag }}"></p>
     <p>Your email (optional):<br> <input type="text" name="email" value="{{ email }}"></p>
     <p>Pick your database (default: human_reduced TODO:TURN INTO SELECTOR):<br> <input type="text" name="db" value="{{ db }}"></p>
  </form>
  
  <!--<button onclick="submit_job();">Start Long Calculation</button><br><br>-->
  <button id="start-bg-job">Submit your query to the server</button><br><br>
  <div id="progress"></div>

  <br>


 
  <script src="//cdnjs.cloudflare.com/ajax/libs/nanobar/0.2.1/nanobar.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script>
      function submit_job() {
            // add task status elements
            div = $('<div class="progress"><div></div><div></div></div><hr>');
            $('#progress').append(div);

            // send ajax POST request to start background job
            $.ajax( {
                type: 'POST',
                url: '/submit',
                data: $('form').serialize(),
               success: function(data, status, request) {
                    status_url = request.getResponseHeader('Location');
                    update_progress(status_url, div[0]);
                },
                error: function() {
                    alert('Unexpected error');
                }
            });
        }
        function update_progress(status_url, status_div) {
           // send GET request to status URL
           $.getJSON(status_url, function(data) {
              // update UI
              $(status_div.childNodes[0]).text('Status:' + data['state']);
              $(status_div.childNodes[1]).text('Status:' + data['status']);
              if( data['state'] == 'completed'){
                 setTimeout( function(){}, 5000);
                 window.location = "\"/results/" + {{email}} + "/" + {{tag}}  ";
              }
              else {
                 // rerun in 2 seconds
                 setTimeout(function() {
                    update_progress(status_url, status_div);
                 }, 5000);
              }
           });
        }
        $(function() {
            $('#start-bg-job').click(submit_job);
        });
   </script>
   
</center>  
{% endblock %}

{% extends "base.html" %}

{% block title %}{{super()}} - Submit Query {% endblock %}

{% block page_content %}
{{super()}}

<center>
  
  <h3> Submit your protein sequence to search for potential protein binders.</h3>

  <br><br>

  <br><br>

  
      <!--
 <form action="" method="post" novalidate>
    {{ form.hidden_tag() }}
    <p>
      {{ form.db.label }}<br>
            {{ form.db( id='btn btn-primary') }}
    </p>
  </form>
  <br><br>

      <div style="width:75%">
      {{ wtf.quick_form(form) }}
      </div>
      -->

  
  <form method="POST" style="width:75%"novalidate>
    {{ form.hidden_tag() }}
    <p >
      {{ form.sequence.label }}<br>
      {{ form.sequence( style='width:100', class='form-control') }}
    </p>
    {% for message in form.sequence.errors %}
    <div class="warning">{{ message }}</div>
    {% endfor %}
    <br>
    <p>
      {{ form.tag.label }}<br>
            {{ form.tag( class='form-control') }}
    </p>
    {% for message in form.tag.errors %}
    <div class="warning">{{ message }}</div>
    {% endfor %}
    <br>
    <p>
      {{ form.email.label }}<br>
            {{ form.email( class='form-control') }}
    </p>
    {% for message in form.email.errors %}
    <div class="warning">{{ message }}</div>
    {% endfor %}
    <br>
    <p>
      {{ form.db.label }}<br>
            {{ form.db( class='btn btn-primary btn-lg') }}
    </p>
    {% for message in form.db.errors %}
    <div class="warning">{{ message }}</div>
    {% endfor %}
    <br>
    <p>
      <!--<input onclick="submit_job();">Start Calculation</button><br><br>-->
      {{ form.submit.label }}<br>
            {{ form.submit( class='btn btn-primary btn-lg', id="start-bg-job" ) }}
    </p>
  </form>
  
  <br>
  <div id="progress"></div>

  <!--
  <form action="" method="post" novalidate>
  <!-- <button onclick="submit_job();">Start Calculation</button><br><br>
  <button class="btn btn-primary" type="submit" id="start-bg-job" >Submit your query to the server</button><br><br>
  </form>
  -->

  <br>

</center>   
{% endblock %}

{% block scripts %}

  <script src="//cdnjs.cloudflare.com/ajax/libs/nanobar/0.2.1/nanobar.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script>
    function submit_job() {
    // check input ...
    
    
            // add task status elements
            div = $('<div class="progress"><div></div><div></div><div></div><div></div></div><hr>');
            $('#progress').append(div);

            // send ajax POST request to start background job
            $.ajax( {
                type: 'POST',
                url: '/submit',
                data: $('form').serialize(),
               success: function(data, status, request) {
                    status_url = request.getResponseHeader('Location');
                    update_progress(status_url, div[0]);
                },
                error: function() {
                    alert('Unexpected error');
                }
            });
        }
        function update_progress(status_url, status_div) {
           // send GET request to status URL
           $.getJSON(status_url, function(data) {
              // update UI
              $(status_div.childNodes[0]).text('Status:' + data['state']);
              $(status_div.childNodes[1]).text('Status:' + data['status']);
      if( data['status'] == 'completed'){

      <!--
	  setTimeout( "window.location.href='results/{{email}}/{{tag}}'",10000);
// -->
      
      $(status_div.childNodes[2]).text('you should be redirected soon, elsewise find results here:' );
      var a = document.createElement('a');
      var t = document.createTextNode("click me");
      a.appendChild(t);
      a.title = "click";
      a.href = "results/{{email}}/{{tag}}";
      $(status_div.childNodes[2]).html( "<a href='results/{{email}}/{{tag}}'>le click</a>");
      document.body.appendChild(a);
      
              }
              else {
                 // rerun in 2 seconds
                 setTimeout(function() {
                    update_progress(status_url, status_div);
                 }, 5000);
              }
           });
        }
        $(function() {
            $('#start-bg-job').click(submit_job);
        });
   </script>

  {{ super() }}
   
{% endblock %}
